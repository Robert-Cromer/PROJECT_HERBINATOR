#include "Arduino_LED_Matrix.h"

// Import drivers for sensors?

// Temporary motor pins

const int ENABLE = 5;
const int DIRA = 3;
const int DIRB = 4;

// -------------------- Pins --------------------
const int PUMP_MOTOR = 10; //D10, PWM
const int WATER_HIGH = 0; //D0
const int WATER_READ = 5; //A5
const int MOISTURE_READ = 0; //A0
const int TEMP_READ = 1; //A1

// How frequently we want to sample the sensors
// Essentially our clock cycle time, which recall is the inverse of frequency.
const unsigned long SENSOR_SAMPLE_MS = 100UL; // read sensors every 1s

// -------------------- Moisture Calibration --------------------
// You MUST calibrate these for your sensor + soil:
// - MOISTURE_DRY: reading when probe is in dry soil (or in air)
// - MOISTURE_WET: reading when probe is in fully wet soil (water-saturated)
// Many capacitive sensors read HIGH when dry and LOWER when wet, but it varies.
const int MOISTURE_DRY = 475; // Read from A0 with moisture sensor in the air.
const int MOISTURE_WET = 210; // Read from A0 with moisture sensor in damp soil/a cup of water

// -------------------- Watering Policy --------------------
// Base thresholds (in % moisture)
const float ON_THRESHOLD_BASE  = 0.25;  // water when moisture drops below this
const float OFF_THRESHOLD_BASE = 0.75;  // stop when moisture rises above this, too wet!
const int WATER_THRESHOLD = 0; // Threshold for when we detect current going thru the water to verify that the water is in the container.

// Temperature adjustment (simple, practical)
// Hotter -> water sooner (raise thresholds slightly) and/or water a bit longer
// Colder -> water later (lower thresholds)
const float HOT_TEMP_C  = 30.0;
const float COLD_TEMP_C = 12.0;
const float TEMP_ADJUST_MAX = 7.0; // max +/- percent points added/subtracted

// Pump timing safety
const char PUMP_PMW_STRENGTH = 255; //128; // Value from 0 to 255 to control the pump speed using PWM.
const unsigned long MAX_PUMP_ON_MS = 10UL * 1000UL; // 10 seconds max per cycle

// -------------------- State --------------------
bool pumpOn = false;
unsigned long pumpStartMs = 0;
unsigned long lastWaterMs = 0;
unsigned long lastSampleMs = 0;

ArduinoLEDMatrix matrix;

enum class State {
  Loop,
  Read,
  EnablePump,
  DisablePump,
  Error,
};

State currentState;

void setup() {
  // temporary
  pinMode(ENABLE,OUTPUT);
  pinMode(DIRA,OUTPUT);
  pinMode(DIRB,OUTPUT);

  // put your setup code here, to run once:
  pinMode(PUMP_MOTOR, OUTPUT);
  pinMode(WATER_HIGH, OUTPUT);
  digitalWrite(WATER_HIGH, HIGH);
  
  pinMode(LED_BUILTIN, OUTPUT); // Initialize the digital pin as an output.

  byte frame[8][12] = {
    { 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0 },
    { 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0 },
    { 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0 },
    { 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0 },
    { 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1 },
    { 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0 },
    { 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0 },
    { 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0 }
  };

  /*
    byte frame[8][12] = {
    { 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0 },
    { 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0 },
    { 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0 },
    { 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0 },
    { 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 }
  };
  */

  currentState = State::Loop;

  matrix.begin();
  matrix.renderBitmap(frame, 8, 12);
  Serial.begin(9600);
}

void pumpSet(bool on) {
  pumpOn = on;

  analogWrite(ENABLE, pumpOn ? PUMP_PMW_STRENGTH : LOW); // enable on
  digitalWrite(DIRA,LOW); //one way
  digitalWrite(DIRB,HIGH);

  if (on) pumpStartMs = millis();
}

float getMoistPct(int raw) {
  return (float)(raw - MOISTURE_DRY) / (MOISTURE_WET - MOISTURE_DRY); // Derived from lerp equation to get moisture pct
}

void loop() {
  unsigned long now = millis();

  switch (currentState) {
    case State::Loop: {
        if (now - lastSampleMs <= SENSOR_SAMPLE_MS) return;

        currentState = State::Read;
        break;
    }
    case State::Read: {
      lastSampleMs = now;

      // Read moisture
      int rawMoist = analogRead(MOISTURE_READ);
      float moistPct = getMoistPct(rawMoist);

      // Read temperature
      float tempC = 0; //sensors.getTempCByIndex(0); Call temperature library from here .    

      int rawWaterPresent = analogRead(WATER_READ);
      bool waterPresent = true; // TEMPORARY OVERRIDE //rawWaterPresent >= WATER_THRESHOLD;

      bool pumpCdExceeded = now - pumpStartMs > MAX_PUMP_ON_MS;

      if (!pumpOn && waterPresent && moistPct <= ON_THRESHOLD_BASE) {
        currentState = State::EnablePump;
        break;
      } else if (pumpOn && (!waterPresent || moistPct >= OFF_THRESHOLD_BASE || pumpCdExceeded)) {
        currentState = State::DisablePump;
        break;
      } else if (!waterPresent) {
        currentState = State::Error;
        break;
      }

      currentState = State::Loop;

      // Debug output
      Serial.print("rawMoist=");
      Serial.print(rawMoist);
      Serial.print(" moist%=");
      Serial.print(moistPct, 1);

      Serial.print(" tempC=");
      // if (tempValid) Serial.print(tempC, 1);
      // else Serial.print("NA");

      Serial.print(" pumpOn=");
      Serial.println(pumpOn ? "YES" : "NO");

      break;
    }
    case State::EnablePump: {
      pumpSet(true);
      currentState = State::Loop;
      break;
    }
    case State::DisablePump: {
      pumpSet(false);
      currentState = State::Loop;
      break;
    }
    case State::Error: {
        Serial.print("ERROR! NO WATER PRESENT!!");
        break;
    }
  }
}
